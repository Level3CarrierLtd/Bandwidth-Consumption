<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FAST Data Usage Tracker</title>
    <style>
        /* General Body Styles */
        body {
            background-color: #FFFFFF;
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            height: 100vh;
            margin: 0;
            color: #424242;
            overflow: hidden;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Hide original elements */
        .meter, .real-time-meter, footer, .central-logo, .meter-logo, #status-text {
            display: none;
        }

        /* Central Controls */
        .controls-container {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        /* নতুন কোড শুরু: Progress Bar Styles */
        .progress-container {
            width: 350px;
            height: 40px;
            background-color: #e0e0e0;
            border-radius: 20px;
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
            border: 1px solid #ccc;
        }

        #progress-bar {
            width: 0%;
            height: 100%;
            background-color: #4CAF50; /* Green color for progress */
            border-radius: 20px;
            transition: width 0.2s ease-out; /* Smooth transition */
        }

        #progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #000000;
            font-size: 18px;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.7);
        }
        /* নতুন কোড শেষ */

        .button-wrapper {
            display: flex;
            align-items: center;
            gap: 20px; /* Space between buttons */
        }

        #pause-button {
            padding: 10px 25px;
            font-size: 18px;
            cursor: pointer;
            border: 2px solid #E50914;
            background-color: #E50914;
            color: white;
            border-radius: 5px;
            transition: background-color 0.3s, color 0.3s;
            width: 120px; /* Fixed width for consistency */
        }

        #pause-button:hover {
            background-color: #c00711;
            border-color: #c00711;
        }

        #refresh-button {
            width: 40px;
            height: 40px;
            border: 2px solid #9E9E9E;
            border-radius: 50%;
            background-color: transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #008000;
            font-size: 24px;
            font-weight: bold;
            transition: transform 0.8s ease-in-out;
        }

        #refresh-button.testing {
            transform: rotate(360deg);
        }
    </style>
</head>
<body>

    <!-- Hidden Data Meters -->
    <div class="meter" id="meter-megabit"><div class="data-usage-container"><span class="data-usage-value" id="megabit-value">0.00</span></div></div>
    <div class="meter" id="meter-megabyte"><div class="data-usage-container"><span class="data-usage-value" id="megabyte-value">0.00</span></div></div>
    <!-- Other hidden meters... -->
    <footer></footer>

    <!-- Central Controls -->
    <div class="controls-container">
        <!-- পরিবর্তিত কোড: h1 এর পরিবর্তে Progress Bar -->
        <div class="progress-container">
            <div id="progress-bar"></div>
            <span id="progress-text">0%</span>
        </div>
        <div class="button-wrapper">
            <button id="pause-button">Pause</button>
            <button id="refresh-button">&#8635;</button>
        </div>
    </div>

    <script>
        // Element references
        const megabitElement = document.getElementById('megabit-value');
        const megabyteElement = document.getElementById('megabyte-value');
        
        // নতুন কোড শুরু: Progress bar elements
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        // নতুন কোড শেষ

        // Control elements
        const refreshButton = document.getElementById('refresh-button');
        const pauseButton = document.getElementById('pause-button');
        
        // Test configuration
        const DOWNLOAD_TEST_FILE = 'https://cachefly.cachefly.net/10mb.test';
        const CONCURRENT_DOWNLOADS = 10;
        const STORAGE_KEY = 'totalDataUsed';
        const RESET_THRESHOLD_BYTES = 100 * 1024 * 1024; // 100 MB in bytes
        
        // State variables
        let continueTesting = false;
        let isPaused = false;
        let activeXHRs = [];
        let totalDownloadedBytes = parseFloat(localStorage.getItem(STORAGE_KEY)) || 0;
        
        let lastProgressTime = Date.now();
        let bytesSinceLastProgress = 0;

        function updateDataUsageDisplay() {
            const megabytes = totalDownloadedBytes / (1024 * 1024);
            megabitElement.textContent = ((totalDownloadedBytes * 8) / (1024 * 1024)).toFixed(2);
            megabyteElement.textContent = megabytes.toFixed(2);

            // নতুন কোড শুরু: Calculate and display percentage
            const percentage = Math.min(100, (totalDownloadedBytes / RESET_THRESHOLD_BYTES) * 100);
            progressBar.style.width = percentage + '%';
            if (!isPaused) {
                progressText.textContent = Math.floor(percentage) + '%';
            }
            // নতুন কোড শেষ

            // Check if threshold is reached for auto-reset
            if (totalDownloadedBytes >= RESET_THRESHOLD_BYTES) {
                console.log("100 MB limit reached. Auto-resetting test.");
                resetTest();
            }
        }

        function runSingleDownload() {
            return new Promise((resolve, reject) => {
                const xhr = new XMLHttpRequest();
                activeXHRs.push(xhr);
                
                let lastLoaded = 0;

                xhr.open('GET', `${DOWNLOAD_TEST_FILE}?r=${Date.now()}&i=${Math.random()}`, true);
                
                xhr.onprogress = (event) => {
                    if (event.lengthComputable) {
                         const bytesDiff = event.loaded - lastLoaded;
                         totalDownloadedBytes += bytesDiff;
                         lastLoaded = event.loaded;
                         updateDataUsageDisplay();
                    }
                };

                xhr.onload = () => (xhr.status === 200 ? resolve() : reject());
                xhr.onerror = () => reject();
                xhr.onabort = () => resolve();
                xhr.send();
            }).finally(() => {
                activeXHRs = activeXHRs.filter(x => x !== xhr);
            });
        }
        
        async function startContinuousTesting() {
            if (continueTesting) return; 

            continueTesting = true;
            isPaused = false;
            pauseButton.textContent = 'Pause';
            refreshButton.classList.add('testing');
            updateDataUsageDisplay(); // Update UI immediately on start/resume

            while (continueTesting) {
                const downloadPromises = Array.from({ length: CONCURRENT_DOWNLOADS }, () => runSingleDownload());
                try {
                    await Promise.all(downloadPromises);
                } catch (error) {
                    console.error("One or more downloads failed. Continuing...");
                }
                if (!continueTesting) break;
            }
            
            refreshButton.classList.remove('testing');
        }
        
        function resetTest() {
            continueTesting = false; 
            activeXHRs.forEach(xhr => xhr.abort());
            activeXHRs = [];
            
            totalDownloadedBytes = 0;
            localStorage.removeItem(STORAGE_KEY);
            updateDataUsageDisplay();
            
            if (isPaused) {
                isPaused = false;
            }
             pauseButton.textContent = 'Pause';
            
            setTimeout(startContinuousTesting, 100);
        }

        pauseButton.addEventListener('click', () => {
            isPaused = !isPaused;
            if (isPaused) {
                continueTesting = false;
                activeXHRs.forEach(xhr => xhr.abort());
                activeXHRs = [];
                progressText.textContent = 'Paused'; // পরিবর্তিত কোড
                pauseButton.textContent = 'Resume';
            } else {
                startContinuousTesting();
            }
        });

        refreshButton.addEventListener('click', resetTest);

        window.addEventListener('beforeunload', () => {
            if (totalDownloadedBytes < RESET_THRESHOLD_BYTES) {
                localStorage.setItem(STORAGE_KEY, totalDownloadedBytes);
            } else {
                localStorage.removeItem(STORAGE_KEY);
            }
        });

        window.onload = () => {
            updateDataUsageDisplay();
            startContinuousTesting();
        };

    </script>
</body>
</html>
